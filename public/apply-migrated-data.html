<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicar Dados Migrados - SuaGrana</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Migra√ß√£o de Dados - SuaGrana</h1>
            <p>Aplicar dados migrados do banco SQLite para localStorage</p>
        </div>

        <div id="status-container"></div>

        <div class="stats" id="stats-container" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="transactions-count">0</div>
                <div class="stat-label">Transa√ß√µes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="accounts-count">0</div>
                <div class="stat-label">Contas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="goals-count">0</div>
                <div class="stat-label">Metas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="investments-count">0</div>
                <div class="stat-label">Investimentos</div>
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="applyMigratedData()">üöÄ Aplicar Dados Migrados</button>
            <button class="btn" onclick="clearAllData()">üßπ Limpar Todos os Dados</button>
            <button class="btn" onclick="checkCurrentData()">üìä Verificar Dados Atuais</button>
        </div>

        <div class="log" id="log-container"></div>

        <div class="status info">
            <strong>üìã Instru√ß√µes:</strong><br>
            1. Clique em "Aplicar Dados Migrados" para carregar os dados do banco<br>
            2. Aguarde a confirma√ß√£o de sucesso<br>
            3. Acesse <a href="http://localhost:3001" target="_blank">http://localhost:3001</a> para ver os dados<br>
            4. Recarregue a p√°gina da aplica√ß√£o se necess√°rio
        </div>
    </div>

    <script>
        let logContainer = document.getElementById('log-container');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logContainer.innerHTML += logEntry + '\n';
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(logEntry);
        }

        function showStatus(message, type = 'info') {
            const statusContainer = document.getElementById('status-container');
            statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function updateStats(data) {
            document.getElementById('transactions-count').textContent = data['sua-grana-transactions']?.length || 0;
            document.getElementById('accounts-count').textContent = data['sua-grana-accounts']?.length || 0;
            document.getElementById('goals-count').textContent = data['sua-grana-goals']?.length || 0;
            document.getElementById('investments-count').textContent = data['sua-grana-investments']?.length || 0;
            document.getElementById('stats-container').style.display = 'grid';
        }

        async function loadMigratedData() {
            try {
                const response = await fetch('/load-migrated-data.js');
                const scriptContent = await response.text();
                
                // Extrair os dados do script
                const dataMatch = scriptContent.match(/const data = ({[\s\S]*?});/);
                if (!dataMatch) {
                    throw new Error('N√£o foi poss√≠vel extrair os dados do arquivo');
                }
                
                return JSON.parse(dataMatch[1]);
            } catch (error) {
                throw new Error(`Erro ao carregar dados: ${error.message}`);
            }
        }

        async function applyMigratedData() {
            try {
                log('üîÑ Iniciando aplica√ß√£o dos dados migrados...');
                showStatus('üîÑ Carregando dados migrados...', 'info');
                
                const data = await loadMigratedData();
                log(`‚úÖ Dados carregados: ${Object.keys(data).length} categorias`);
                
                // Aplicar dados no localStorage
                Object.entries(data).forEach(([key, value]) => {
                    localStorage.setItem(key, JSON.stringify(value));
                    const count = Array.isArray(value) ? value.length : 'configurado';
                    log(`‚úÖ Aplicado ${key}: ${count} ${Array.isArray(value) ? 'itens' : ''}`);
                });
                
                // Limpar caches
                const cacheKeys = Object.keys(localStorage).filter(key => 
                    key.includes('cache') || key.includes('storage-cache') || key.includes('optimized')
                );
                cacheKeys.forEach(key => {
                    localStorage.removeItem(key);
                    log(`üßπ Cache limpo: ${key}`);
                });
                
                updateStats(data);
                showStatus('‚úÖ Dados aplicados com sucesso! Acesse a aplica√ß√£o para ver os resultados.', 'success');
                log('‚úÖ Migra√ß√£o conclu√≠da com sucesso!');
                
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
                showStatus(`‚ùå Erro na migra√ß√£o: ${error.message}`, 'error');
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja limpar todos os dados do localStorage?')) {
                const keys = Object.keys(localStorage).filter(key => key.startsWith('sua-grana-'));
                keys.forEach(key => {
                    localStorage.removeItem(key);
                    log(`üóëÔ∏è Removido: ${key}`);
                });
                
                showStatus('üßπ Todos os dados foram limpos.', 'warning');
                log('üßπ Limpeza conclu√≠da.');
                document.getElementById('stats-container').style.display = 'none';
            }
        }

        function checkCurrentData() {
            log('üìä Verificando dados atuais no localStorage...');
            
            const keys = ['sua-grana-transactions', 'sua-grana-accounts', 'sua-grana-goals', 'sua-grana-investments'];
            const currentData = {};
            
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        currentData[key] = parsed;
                        log(`üìã ${key}: ${Array.isArray(parsed) ? parsed.length : 'configurado'} ${Array.isArray(parsed) ? 'itens' : ''}`);
                    } catch (e) {
                        log(`‚ö†Ô∏è ${key}: erro ao analisar dados`);
                    }
                } else {
                    log(`‚ùå ${key}: n√£o encontrado`);
                }
            });
            
            if (Object.keys(currentData).length > 0) {
                updateStats(currentData);
                showStatus('üìä Dados encontrados no localStorage.', 'info');
            } else {
                showStatus('‚ùå Nenhum dado encontrado no localStorage.', 'warning');
            }
        }

        // Verificar dados ao carregar a p√°gina
        window.onload = function() {
            log('üöÄ Sistema de migra√ß√£o carregado.');
            checkCurrentData();
        };
    </script>
</body>
</html>